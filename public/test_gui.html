<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Examples Loading Test</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #1e1e1e;
            color: #d4d4d4;
            padding: 20px;
            line-height: 1.6;
        }
        .test-container {
            max-width: 1200px;
            margin: 0 auto;
        }
        .test-section {
            background-color: #2d2d30;
            border: 1px solid #3e3e42;
            border-radius: 5px;
            padding: 20px;
            margin: 20px 0;
        }
        .test-result {
            padding: 8px 12px;
            margin: 5px 0;
            border-radius: 3px;
            font-family: monospace;
        }
        .success { background-color: #0e5a2b; color: #4ec9b0; }
        .error { background-color: #5a1e1e; color: #f44747; }
        .info { background-color: #2d2d30; color: #dcdcaa; }
        .warning { background-color: #5a4a1e; color: #d19a66; }
        
        iframe {
            width: 100%;
            height: 600px;
            border: 1px solid #3e3e42;
            border-radius: 5px;
            background: white;
        }
        
        button {
            background-color: #0e639c;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 3px;
            cursor: pointer;
            margin: 5px;
            font-size: 14px;
        }
        
        button:hover {
            background-color: #1177bb;
        }
        
        .test-controls {
            margin: 20px 0;
        }
        
        h2 {
            color: #4ec9b0;
            border-bottom: 1px solid #3e3e42;
            padding-bottom: 10px;
        }
        
        /* Footer Styles */
        .footer {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background-color: #252526;
            border-top: 1px solid #3e3e42;
            padding: 10px 20px;
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 20px;
            font-size: 14px;
            z-index: 1000;
        }
        
        .footer-item {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .footer-contact {
            position: relative;
            cursor: pointer;
            color: #4ec9b0;
            text-decoration: none;
            transition: color 0.2s;
        }
        
        .footer-contact:hover {
            color: #6edbc9;
        }
        
        .qr-tooltip {
            position: absolute;
            bottom: 100%;
            left: 50%;
            transform: translateX(-50%);
            margin-bottom: 10px;
            padding: 10px;
            background-color: #1e1e1e;
            border: 1px solid #3e3e42;
            border-radius: 5px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.5);
            display: none;
            z-index: 1001;
        }
        
        .qr-tooltip img {
            width: 150px;
            height: 150px;
            display: block;
        }
        
        .footer-contact:hover .qr-tooltip,
        .footer-contact.active .qr-tooltip {
            display: block;
        }
        
        .footer-copyright {
            color: #888;
        }
        
        .footer-icp {
            color: #4ec9b0;
            text-decoration: none;
            transition: color 0.2s;
        }
        
        .footer-icp:hover {
            color: #6edbc9;
            text-decoration: underline;
        }
        
        /* Adjust container for footer */
        body {
            padding-bottom: 60px;
        }
    </style>
</head>
<body>
    <div class="test-container">
        <h1>üêç Python WASM Demo - Examples Loading Test</h1>
        
        <div class="test-section">
            <h2>üìã Test Results</h2>
            <div id="test-results">
                <div class="test-result info">Starting automated tests...</div>
            </div>
        </div>
        
        <div class="test-section">
            <h2>üéÆ Manual Test Controls</h2>
            <div class="test-controls">
                <button onclick="runAutomatedTests()">üîÑ Run Tests Again</button>
                <button onclick="testFileClick()">üìÅ Test File Click</button>
                <button onclick="testEditorContent()">üìù Check Editor Content</button>
                <button onclick="clearResults()">üßπ Clear Results</button>
            </div>
        </div>
        
        <div class="test-section">
            <h2>üñ•Ô∏è Application Preview</h2>
            <iframe src="/editor.html" id="appFrame"></iframe>
        </div>
    </div>

    <script>
        const results = document.getElementById('test-results');
        let testFrame = null;
        
        function addResult(message, type = 'info') {
            const div = document.createElement('div');
            div.className = `test-result ${type}`;
            div.innerHTML = `<strong>${new Date().toLocaleTimeString()}</strong> ${message}`;
            results.appendChild(div);
            div.scrollIntoView({ behavior: 'smooth' });
        }
        
        function clearResults() {
            results.innerHTML = '<div class="test-result info">Results cleared - ready for new tests</div>';
        }
        
        function runAutomatedTests() {
            addResult('üöÄ Starting automated examples loading tests...', 'info');
            
            testFrame = document.getElementById('appFrame');
            
            // Test 1: Frame loads
            setTimeout(() => {
                try {
                    addResult('üì° Testing iframe accessibility...', 'info');
                    
                    // Try to access iframe content (may fail due to same-origin policy)
                    try {
                        const iframeDoc = testFrame.contentDocument || testFrame.contentWindow.document;
                        if (iframeDoc) {
                            addResult('‚úÖ Iframe content is accessible', 'success');
                            testDOMElements(iframeDoc, testFrame.contentWindow);
                        } else {
                            addResult('‚ùå Cannot access iframe content (same-origin policy)', 'error');
                            testExternalAccess();
                        }
                    } catch (e) {
                        addResult('‚ö†Ô∏è CORS restriction - testing externally: ' + e.message, 'warning');
                        testExternalAccess();
                    }
                } catch (error) {
                    addResult('‚ùå Error during test: ' + error.message, 'error');
                }
            }, 2000);
        }
        
        function testDOMElements(iframeDoc, iframeWindow) {
            addResult('üîç Testing DOM elements in iframe...', 'info');
            
            // Wait a moment for any initialization to complete
            setTimeout(() => {
                // Test file tree
                const fileTree = iframeDoc.getElementById('file-tree');
                if (fileTree) {
                    addResult(`‚úÖ File tree found with ${fileTree.children.length} items`, 'success');
                    
                    // If file tree is empty, try to trigger updateFileTree
                    if (fileTree.children.length === 0 && iframeWindow.updateFileTree) {
                        addResult('üîÑ File tree empty, triggering updateFileTree...', 'info');
                        try {
                            iframeWindow.updateFileTree();
                            setTimeout(() => {
                                addResult(`üìä After updateFileTree: ${fileTree.children.length} items`, 'info');
                            }, 500);
                        } catch (error) {
                            addResult('‚ùå Error calling updateFileTree: ' + error.message, 'error');
                        }
                    }
                    
                    // List files
                    for (let i = 0; i < Math.min(5, fileTree.children.length); i++) {
                        const item = fileTree.children[i];
                        addResult(`üìÑ File ${i + 1}: ${item.textContent}`, 'info');
                    }
                    
                    if (fileTree.children.length > 5) {
                        addResult(`üìÅ ...and ${fileTree.children.length - 5} more files`, 'info');
                    }
                } else {
                    addResult('‚ùå File tree not found', 'error');
                }
            }, 500); // Wait 500ms for initialization
            
            // Test sidebar
            const sidebar = iframeDoc.getElementById('sidebar');
            if (sidebar) {
                addResult('‚úÖ Sidebar element found', 'success');
            } else {
                addResult('‚ùå Sidebar element missing', 'error');
            }
            
            // Test editor
            const editor = iframeDoc.getElementById('editor');
            if (editor) {
                addResult('‚úÖ Editor container found', 'success');
            } else {
                addResult('‚ùå Editor container missing', 'error');
            }
            
            // Test JavaScript variables with retry for templates
            if (iframeWindow.exampleFiles) {
                addResult(`‚úÖ exampleFiles array found with ${iframeWindow.exampleFiles.length} items`, 'success');
            } else {
                addResult('‚ùå exampleFiles array not found', 'error');
            }
            
            function checkTemplates(attempt = 1) {
                if (iframeWindow.exampleTemplates) {
                    const templateCount = Object.keys(iframeWindow.exampleTemplates).length;
                    if (templateCount > 0) {
                        addResult(`‚úÖ exampleTemplates object found with ${templateCount} templates`, 'success');
                        
                        // List first few templates
                        const templateNames = Object.keys(iframeWindow.exampleTemplates);
                        templateNames.slice(0, 3).forEach(name => {
                            addResult(`   üìÑ Template: ${name}`, 'info');
                        });
                        if (templateNames.length > 3) {
                            addResult(`   üìÅ ...and ${templateNames.length - 3} more templates`, 'info');
                        }
                    } else if (attempt < 5) {
                        addResult(`‚è≥ exampleTemplates empty, retrying... (attempt ${attempt})`, 'warning');
                        setTimeout(() => checkTemplates(attempt + 1), 1000);
                    } else {
                        addResult('‚ùå exampleTemplates object found but remains empty after retries', 'error');
                    }
                } else {
                    addResult('‚ùå exampleTemplates object not found', 'error');
                }
            }
            
            checkTemplates();
            
            // Test functions
            if (typeof iframeWindow.loadFile === 'function') {
                addResult('‚úÖ loadFile function found', 'success');
            } else {
                addResult('‚ùå loadFile function missing', 'error');
            }
            
            if (typeof iframeWindow.updateFileTree === 'function') {
                addResult('‚úÖ updateFileTree function found', 'success');
            } else {
                addResult('‚ùå updateFileTree function missing', 'error');
            }
        }
        
        function testExternalAccess() {
            addResult('üåê Testing external HTTP requests...', 'info');
            
            fetch('/editor.html')
                .then(response => response.text())
                .then(html => {
                    addResult('‚úÖ Successfully fetched editor.html', 'success');
                    
                    // Test for examples in HTML
                    if (html.includes('exampleFiles')) {
                        addResult('‚úÖ exampleFiles found in HTML source', 'success');
                    } else {
                        addResult('‚ùå exampleFiles not found in HTML source', 'error');
                    }
                    
                    if (html.includes('Welcome to Python Online IDE!')) {
                        addResult('‚úÖ Welcome content found in HTML source', 'success');
                    } else {
                        addResult('‚ùå Welcome content not found in HTML source', 'error');
                    }
                    
                    if (html.includes("addEventListener('DOMContentLoaded'")) {
                        addResult('‚úÖ DOMContentLoaded fix found in HTML source', 'success');
                    } else {
                        addResult('‚ùå DOMContentLoaded fix not found in HTML source', 'error');
                    }
                })
                .catch(error => {
                    addResult('‚ùå Failed to fetch editor.html: ' + error.message, 'error');
                });
        }
        
        function testFileClick() {
            addResult('üñ±Ô∏è Testing file click simulation...', 'info');
            try {
                const iframeDoc = testFrame.contentDocument || testFrame.contentWindow.document;
                const fileTree = iframeDoc.getElementById('file-tree');
                
                if (fileTree && fileTree.children.length > 1) {
                    const secondFile = fileTree.children[1];
                    addResult(`üìÅ Attempting to click: ${secondFile.textContent}`, 'info');
                    
                    if (secondFile.onclick) {
                        secondFile.click();
                        addResult('‚úÖ File click simulated successfully', 'success');
                        
                        setTimeout(() => {
                            testEditorContent();
                        }, 1000);
                    } else {
                        addResult('‚ùå File has no click handler', 'error');
                    }
                } else {
                    addResult('‚ùå No files available to click', 'error');
                }
            } catch (error) {
                addResult('‚ùå Cannot simulate click: ' + error.message, 'error');
            }
        }
        
        function testEditorContent() {
            addResult('üìù Testing editor content...', 'info');
            try {
                const iframeWindow = testFrame.contentWindow;
                
                if (iframeWindow.editor && typeof iframeWindow.editor.getValue === 'function') {
                    const content = iframeWindow.editor.getValue();
                    if (content && content.trim().length > 0) {
                        addResult(`‚úÖ Editor has content (${content.length} characters)`, 'success');
                        addResult(`üìñ Content preview: "${content.substring(0, 100)}..."`, 'info');
                    } else {
                        addResult('‚ö†Ô∏è Editor appears empty', 'warning');
                    }
                } else {
                    addResult('‚ùå Editor not accessible or no getValue method', 'error');
                }
                
                if (iframeWindow.currentFile) {
                    addResult(`‚úÖ Current file: ${iframeWindow.currentFile}`, 'success');
                } else {
                    addResult('‚ö†Ô∏è No current file set', 'warning');
                }
                
                if (iframeWindow.files && iframeWindow.files.size > 0) {
                    addResult(`‚úÖ Files in memory: ${iframeWindow.files.size}`, 'success');
                } else {
                    addResult('‚ö†Ô∏è No files loaded in memory', 'warning');
                }
                
            } catch (error) {
                addResult('‚ùå Cannot access editor: ' + error.message, 'error');
            }
        }
        
        // Auto-start tests when page loads
        window.addEventListener('load', () => {
            setTimeout(runAutomatedTests, 1000);
        });
    </script>
    
    <!-- Footer -->
    <div class="footer">
        <div class="footer-item">
            <a href="#" class="footer-contact" id="footer-contact">
                ËÅîÁ≥ªÂèçÈ¶à
                <div class="qr-tooltip">
                    <img src="https://yunbiyun.com/qiyeweixin.png" alt="‰ºÅ‰∏öÂæÆ‰ø°‰∫åÁª¥Á†Å">
                </div>
            </a>
        </div>
        <div class="footer-item footer-copyright">
            ¬© 2025 ÂπøÂ∑û‰∫ëÊÄù‰ø°ÊÅØÊäÄÊúØÊúâÈôêÂÖ¨Âè∏
        </div>
        <div class="footer-item">
            <a href="https://beian.miit.gov.cn" target="_blank" class="footer-icp">Á≤§ICPÂ§á19043749Âè∑-4</a>
        </div>
    </div>

    <script>
        // Footer contact click handler
        document.getElementById('footer-contact').addEventListener('click', function(e) {
            e.preventDefault();
            this.classList.toggle('active');
        });
        
        // Close QR code when clicking outside
        document.addEventListener('click', function(e) {
            const contact = document.getElementById('footer-contact');
            if (!contact.contains(e.target)) {
                contact.classList.remove('active');
            }
        });
    </script>
</body>
</html>