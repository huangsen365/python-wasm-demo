<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Python Online IDE</title>
    <link rel="stylesheet" data-name="vs/editor/editor.main" href="https://cdn-jsdelivr-net.jiasu.yunbiyun.com/npm/monaco-editor@0.52.2/min/vs/editor/editor.main.css">
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #1e1e1e;
            color: #d4d4d4;
            height: 100vh;
            display: flex;
            flex-direction: column;
        }

        #header {
            background-color: #2d2d30;
            padding: 10px 20px;
            display: flex;
            align-items: center;
            gap: 20px;
            border-bottom: 1px solid #3e3e42;
        }

        #header h1 {
            font-size: 20px;
            font-weight: normal;
            color: #cccccc;
        }

        .toolbar {
            display: flex;
            gap: 10px;
            margin-left: auto;
        }

        .btn {
            background-color: #0e639c;
            color: white;
            border: none;
            padding: 6px 12px;
            border-radius: 3px;
            cursor: pointer;
            font-size: 14px;
            transition: background-color 0.2s;
        }

        .btn:hover {
            background-color: #1177bb;
        }

        .btn:disabled {
            background-color: #3e3e42;
            cursor: not-allowed;
        }

        .btn-success {
            background-color: #4ec9b0;
        }

        .btn-success:hover {
            background-color: #3ca08a;
        }

        .btn-warning {
            background-color: #d19a66;
        }

        .btn-warning:hover {
            background-color: #b8864f;
        }

        #main-container {
            flex: 1;
            display: flex;
            overflow: hidden;
            min-height: 0;  /* Critical for nested flex layouts */
        }

        #sidebar {
            width: 200px;
            background-color: #252526;
            border-right: 1px solid #3e3e42;
            display: flex;
            flex-direction: column;
            transition: transform 0.3s ease;
        }

        #file-explorer {
            flex: 1;
            overflow-y: auto;
            padding: 10px;
        }

        .file-tree {
            list-style: none;
        }

        .file-item {
            padding: 4px 8px;
            cursor: pointer;
            border-radius: 3px;
            display: flex;
            align-items: center;
            gap: 5px;
            user-select: none;
        }

        .file-item:hover {
            background-color: #2a2d2e;
        }

        .file-item.active {
            background-color: #094771;
        }

        .file-icon {
            width: 16px;
            height: 16px;
            display: inline-block;
        }

        #content {
            flex: 1;
            display: flex;
            flex-direction: column;
            min-height: 0;  /* Allow proper shrinking in nested flex */
        }

        #tabs {
            background-color: #2d2d30;
            display: flex;
            border-bottom: 1px solid #3e3e42;
            overflow-x: auto;
        }

        .tab {
            padding: 8px 16px;
            cursor: pointer;
            border-right: 1px solid #3e3e42;
            display: flex;
            align-items: center;
            gap: 8px;
            white-space: nowrap;
        }

        .tab:hover {
            background-color: #323233;
        }

        .tab.active {
            background-color: #1e1e1e;
            border-bottom: 2px solid #007acc;
        }

        .tab-close {
            margin-left: 5px;
            cursor: pointer;
            opacity: 0.6;
        }

        .tab-close:hover {
            opacity: 1;
        }

        #editor-container {
            flex: 1;
            display: flex;
            min-height: 0;  /* Critical for flex shrinking */
            flex-direction: row;  /* Default: horizontal layout */
        }

        #editor {
            flex: 1;
            min-height: 0;  /* Allow proper shrinking in flex layout */
        }

        #terminal-container {
            width: 40%;
            background-color: #1e1e1e;
            border-left: 1px solid #3e3e42;
            display: flex;
            flex-direction: column;
            min-height: 0;  /* Critical for flex shrinking */
            position: relative;
            overflow: hidden;  /* Prevent container itself from scrolling */
            transition: width 0.3s ease;
        }

        #terminal-header {
            background-color: #2d2d30;
            padding: 8px 12px;
            border-bottom: 1px solid #3e3e42;
            font-size: 14px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        #terminal {
            flex: 1 1 auto;  /* Explicit flex-grow, flex-shrink, flex-basis */
            min-height: 0;  /* Critical: Allow content to shrink in flex container */
            max-height: 100%;  /* Limit maximum height */
            padding: 10px;
            /* Critical: Enable vertical scrolling */
            overflow-y: auto;
            overflow-x: hidden;
            position: relative;
            font-family: 'Consolas', 'Courier New', monospace;
            font-size: 14px;
            background: #1e1e1e;
            /* Firefox scrollbar styling */
            scrollbar-width: thin;
            scrollbar-color: #555 #2d2d2d;
        }

        /* Custom scrollbar styling for WebKit browsers */
        #terminal::-webkit-scrollbar {
            width: 12px;
        }

        #terminal::-webkit-scrollbar-track {
            background: #2d2d2d;
            border-radius: 6px;
        }

        #terminal::-webkit-scrollbar-thumb {
            background: #555;
            border-radius: 6px;
        }

        #terminal::-webkit-scrollbar-thumb:hover {
            background: #777;
        }

        /* Note: min-height: 0 is now set individually on each element above */
        
        /* Terminal output styling */
        #terminal-output {
            white-space: pre-wrap;
            word-wrap: break-word;
            overflow: visible;  /* Important: only #terminal should handle overflow */
            min-height: 0;
            flex-shrink: 0;  /* Prevent content from being compressed */
            position: relative;
            color: #d4d4d4;
            line-height: 1.4;
            margin-bottom: 10px;
        }
        
        #terminal-output > div {
            margin-bottom: 2px;
        }

        #terminal-input-line {
            display: flex;
            margin-top: 10px;
        }

        #terminal-prompt {
            color: #4ec9b0;
            margin-right: 5px;
        }

        #terminal-input {
            flex: 1;
            background: transparent;
            border: none;
            color: #d4d4d4;
            font-family: inherit;
            font-size: inherit;
            outline: none;
        }

        .loading {
            color: #dcdcaa;
        }

        .error {
            color: #f44747;
            font-weight: 500;
        }

        .success {
            color: #4ec9b0;
            font-weight: 500;
        }

        .output {
            color: #cccccc;
        }
        
        .info {
            color: #3794ff;
        }
        
        .warning {
            color: #ff9500;
        }
        
        .command {
            color: #569cd6;
            font-weight: 500;
        }
        
        .running {
            color: #4ec9b0;
            font-weight: bold;
            background: rgba(78, 201, 176, 0.1);
            padding: 2px 8px;
            border-radius: 3px;
            margin: 2px 0;
        }
        
        .prompt {
            color: #c586c0;
            font-weight: bold;
        }
        
        /* Special styling for Python print output */
        .python-output {
            color: #ce9178;
            background: rgba(206, 145, 120, 0.05);
            padding-left: 20px;
            border-left: 3px solid rgba(206, 145, 120, 0.3);
        }

        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
        }

        .modal-content {
            background-color: #2d2d30;
            margin: 20% auto;
            padding: 20px;
            border: 1px solid #3e3e42;
            width: 300px;
            border-radius: 5px;
        }

        .modal-content input {
            width: 100%;
            padding: 8px;
            margin: 10px 0;
            background-color: #1e1e1e;
            border: 1px solid #3e3e42;
            color: #d4d4d4;
            border-radius: 3px;
        }

        .modal-buttons {
            display: flex;
            gap: 10px;
            justify-content: flex-end;
            margin-top: 15px;
        }

        .resize-handle {
            background-color: #3e3e42;
            position: relative;
        }
        
        /* Horizontal resize (default) */
        .resize-handle.horizontal {
            width: 5px;
            cursor: col-resize;
        }
        
        /* Vertical resize (for narrow screens) */
        .resize-handle.vertical {
            height: 5px;
            width: 100%;
            cursor: row-resize;
        }

        .resize-handle:hover {
            background-color: #007acc;
        }

        .memory-info {
            font-size: 12px;
            opacity: 0.7;
        }
        
        /* Footer Styles */
        .footer {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background-color: #252526;
            border-top: 1px solid #3e3e42;
            padding: 10px 20px;
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 20px;
            font-size: 14px;
            z-index: 1000;
        }
        
        .footer-item {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .footer-contact {
            position: relative;
            cursor: pointer;
            color: #4ec9b0;
            text-decoration: none;
            transition: color 0.2s;
        }
        
        .footer-contact:hover {
            color: #6edbc9;
        }
        
        .qr-tooltip {
            position: absolute;
            bottom: 100%;
            left: 50%;
            transform: translateX(-50%);
            margin-bottom: 10px;
            padding: 10px;
            background-color: #1e1e1e;
            border: 1px solid #3e3e42;
            border-radius: 5px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.5);
            display: none;
            z-index: 1001;
        }
        
        .qr-tooltip img {
            width: 150px;
            height: 150px;
            display: block;
        }
        
        .footer-contact:hover .qr-tooltip,
        .footer-contact.active .qr-tooltip {
            display: block;
        }
        
        .footer-copyright {
            color: #888;
        }
        
        .footer-icp {
            color: #4ec9b0;
            text-decoration: none;
            transition: color 0.2s;
        }
        
        .footer-icp:hover {
            color: #6edbc9;
            text-decoration: underline;
        }

        .footer-link {
            color: #4ec9b0;
            text-decoration: none;
            transition: color 0.2s;
        }

        .footer-link:hover {
            color: #6edbc9;
            text-decoration: underline;
        }
        
        /* Adjust main container to account for footer */
        #main-container {
            height: calc(100vh - 60px - 50px); /* header height + footer height */
        }
        
        body {
            padding-bottom: 0; /* Footer is fixed, no need for padding */
        }

        /* Mobile menu toggle button */
        .mobile-menu-toggle {
            display: none;
            background: transparent;
            border: none;
            color: #cccccc;
            font-size: 24px;
            cursor: pointer;
            padding: 5px;
            margin-right: 10px;
        }

        /* Layout toggle button */
        .layout-toggle {
            display: none;
            background-color: #3e3e42;
            color: #cccccc;
            border: none;
            padding: 6px 12px;
            border-radius: 3px;
            cursor: pointer;
            font-size: 14px;
            margin-left: 10px;
        }

        .layout-toggle:hover {
            background-color: #4e4e52;
        }

        /* Responsive styles */
        @media (max-width: 1024px) {
            #sidebar {
                width: 180px;
            }
            
            #terminal-container {
                width: 35%;
            }
        }

        @media (max-width: 768px) {
            .mobile-menu-toggle {
                display: block;
            }
            
            .layout-toggle {
                display: none;  /* Remove the layout toggle button */
            }
            
            #header h1 {
                font-size: 16px;
            }
            
            .toolbar {
                gap: 5px;
            }
            
            .btn {
                padding: 5px 8px;
                font-size: 12px;
            }
            
            #sidebar {
                position: fixed;
                left: 0;
                top: 0;
                height: 100vh;
                z-index: 999;
                transform: translateX(-100%);
                width: 250px;
            }
            
            #sidebar.mobile-open {
                transform: translateX(0);
                box-shadow: 2px 0 10px rgba(0,0,0,0.5);
            }
            
            #content {
                width: 100%;
            }
            
            /* Change to vertical layout on narrow screens */
            #editor-container {
                flex-direction: column;
            }
            
            #editor {
                width: 100% !important;
                height: 60%;
                min-height: 200px;
            }
            
            .resize-handle {
                width: 100% !important;
                height: 5px !important;
                cursor: row-resize !important;
            }
            
            #terminal-container {
                width: 100% !important;
                height: 40%;
                min-height: 150px;
                border-left: none;
                border-top: 1px solid #3e3e42;
            }
            
            .footer {
                font-size: 12px;
                padding: 8px 10px;
                gap: 10px;
                flex-wrap: wrap;
            }
            
            .footer-item {
                font-size: 11px;
            }
        }

        @media (max-width: 480px) {
            #header {
                padding: 8px 10px;
            }
            
            #header h1 {
                font-size: 14px;
                display: none;
            }
            
            .btn span.btn-text {
                display: none;
            }
            
            .btn-icon-only::after {
                font-family: monospace;
            }
            
            .btn-new::after { content: '+'; }
            .btn-save::after { content: 'üíæ'; }
            .btn-run::after { content: '‚ñ∂'; }
            .btn-clear::after { content: 'üóë'; }
            .btn-memory::after { content: 'üßπ'; }
            
            #tabs {
                font-size: 12px;
            }
            
            .tab {
                padding: 6px 10px;
            }
            
            #terminal {
                font-size: 12px;
            }
            
            .footer {
                font-size: 10px;
                justify-content: center;
                text-align: center;
            }
            
            .footer-item {
                font-size: 10px;
                width: 100%;
            }
        }

        /* Overlay for mobile sidebar */
        .mobile-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
            z-index: 998;
        }

        .mobile-overlay.active {
            display: block;
        }

        /* iPad specific adjustments */
        @media (min-width: 768px) and (max-width: 1024px) and (orientation: portrait) {
            #sidebar {
                width: 200px;
            }
            
            #terminal-container {
                width: 40%;
            }
        }

        @media (min-width: 768px) and (max-width: 1024px) and (orientation: landscape) {
            #header h1 {
                font-size: 18px;
            }
            
            .btn {
                padding: 5px 10px;
            }
        }
    </style>
</head>
<body>
    <div id="header">
        <button class="mobile-menu-toggle" onclick="toggleMobileSidebar()">‚ò∞</button>
        <h1>Python Online IDE</h1>
        <div class="toolbar">
            <button class="btn btn-new btn-icon-only" onclick="newFile()"><span class="btn-text">New File</span></button>
            <button class="btn btn-save btn-icon-only" onclick="saveFile()"><span class="btn-text">Save</span></button>
            <button class="btn btn-success btn-run btn-icon-only" onclick="runCode()"><span class="btn-text">‚ñ∂ Run</span></button>
            <button class="btn btn-clear btn-icon-only" onclick="clearTerminal()"><span class="btn-text">Clear Terminal</span></button>
            <button class="btn btn-warning btn-memory btn-icon-only" onclick="clearMemory()"><span class="btn-text">Clear Memory</span></button>
            <button class="layout-toggle" onclick="toggleLayout()">Layout</button>
        </div>
    </div>

    <div id="main-container">
        <div id="sidebar">
            <div id="file-explorer">
                <h3 style="margin-bottom: 10px; font-size: 14px;">FILES</h3>
                <ul id="file-tree" class="file-tree"></ul>
            </div>
        </div>

        <div id="content">
            <div id="tabs"></div>
            <div id="editor-container">
                <div id="editor"></div>
                <div class="resize-handle horizontal" id="resize-handle"></div>
                <div id="terminal-container">
                    <div id="terminal-header">
                        <span>TERMINAL</span>
                        <span class="memory-info" id="memory-info">Memory: 0 KB</span>
                    </div>
                    <div id="terminal">
                        <div id="terminal-output">
                            <div class="loading">Loading Python environment...</div>
                        </div>
                        <div id="terminal-input-line" style="display: none;">
                            <span id="terminal-prompt">&gt;&gt;&gt;</span>
                            <input type="text" id="terminal-input" autofocus>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- New File Modal -->
    <div id="newFileModal" class="modal">
        <div class="modal-content">
            <h3>New File</h3>
            <input type="text" id="newFileName" placeholder="filename.py">
            <div class="modal-buttons">
                <button class="btn" onclick="closeModal()">Cancel</button>
                <button class="btn btn-success" onclick="createFile()">Create</button>
            </div>
        </div>
    </div>

    <script src="https://cdn-jsdelivr-net.jiasu.yunbiyun.com/npm/monaco-editor@0.52.2/min/vs/loader.js"></script>
    <script src="https://cdn-jsdelivr-net.jiasu.yunbiyun.com/pyodide/v0.27.7/full/pyodide.js"></script>
    <script>
        // Initialize global variables immediately for testing accessibility
        window.currentFile = null;
        window.files = new Map();
        window.openTabs = [];
        window.exampleFiles = []; // Will be populated dynamically by loadExampleFiles()
        
        // exampleTemplates will be initialized later with full content
        
        // Initialize local variables
        let pyodide;
        let editor;
        let maxTerminalLines = 500;
        let maxOpenTabs = 3;
        let terminalLineCount = 0;
        let debugMode = false; // Toggle this to enable/disable debug logging
        
        // Initialize functions immediately for testing (proper implementation follows)
        window.loadFile = function(filename) {
            console.log('loadFile called early:', filename);
            // Will be replaced by full implementation
        };
        
        window.updateFileTree = function() {
            console.log('updateFileTree called early');
            const fileTree = document.getElementById('file-tree');
            if (fileTree && window.exampleFiles) {
                fileTree.innerHTML = '';
                window.exampleFiles.forEach(fileName => {
                    const li = document.createElement('li');
                    li.className = 'file-item' + (fileName === window.currentFile ? ' active' : '');
                    li.onclick = () => window.loadFile(fileName);
                    const isLoaded = window.files.has(fileName);
                    const icon = isLoaded ? 'üìÑ' : 'üìã';
                    li.innerHTML = `<span class="file-icon">${icon}</span> ${fileName}`;
                    fileTree.appendChild(li);
                });
                console.log('File tree populated with', window.exampleFiles.length, 'items');
            } else {
                console.error('File tree element or exampleFiles not found');
            }
        };

        // Library loading is now handled in specific initialization functions

        // Terminal elements
        const terminalOutput = document.getElementById('terminal-output');
        const terminalInput = document.getElementById('terminal-input');
        const terminalInputLine = document.getElementById('terminal-input-line');
        const memoryInfo = document.getElementById('memory-info');

        // Initialize global variables immediately and ensure they're available
        window.exampleTemplates = {};
        window.exampleFiles = [];
        window.files = new Map();
        window.openTabs = [];
        window.currentFile = null;
        
        console.log('üöÄ JavaScript initializing - global variables set');
        
        // Immediately available stub functions to prevent "not found" errors
        window.loadFile = function(filename) {
            console.log('loadFile called early:', filename, '- will retry when templates are loaded');
            // If templates are loaded, defer to the full implementation
            if (window.exampleTemplates[filename]) {
                window.loadFile = window.loadFileReal || window.loadFile;
                return window.loadFile(filename);
            }
            // Otherwise, try again after a short delay
            setTimeout(() => window.loadFile(filename), 1000);
        };
        
        window.updateFileTree = function() {
            console.log('updateFileTree called early - will update when files are loaded');
            const fileTree = document.getElementById('file-tree');
            if (fileTree) {
                if (window.exampleFiles.length === 0) {
                    fileTree.innerHTML = '<li style="color: #888; padding: 10px;">Loading examples...</li>';
                } else {
                    // Defer to real implementation if available
                    if (window.updateFileTreeReal) {
                        return window.updateFileTreeReal();
                    }
                    // Basic implementation
                    fileTree.innerHTML = '';
                    window.exampleFiles.forEach(fileName => {
                        const li = document.createElement('li');
                        li.className = 'file-item';
                        li.onclick = () => window.loadFile(fileName);
                        li.innerHTML = `<span class="file-icon">üìÑ</span> ${fileName}`;
                        fileTree.appendChild(li);
                    });
                }
            }
        };
        
        // Make these immediately available for tests
        window.globalReady = true;
        
        // Dynamic loading of Python example files
        async function loadExampleFiles() {
            const exampleFilesList = [
                'welcome.py',
                '01_hello_world.py', 
                '02_variables.py',
                '03_lists.py',
                '04_dictionaries.py',
                '05_control_flow.py',
                '06_loops.py',
                '07_functions.py',
                '08_classes.py',
                '09_errors.py',
                '10_modules.py',
                '11_sys_modules.py'
            ];
            
            console.log('üîÑ Loading Python example files...');
            
            let loadedCount = 0;
            let failedFiles = [];
            
            for (const filename of exampleFilesList) {
                try {
                    console.log(`üì° Fetching: /examples/${filename}`);
                    const response = await fetch(`/examples/${filename}`);
                    
                    if (response.ok) {
                        const content = await response.text();
                        if (content && content.trim().length > 0) {
                            window.exampleTemplates[filename] = content;
                            loadedCount++;
                            console.log(`‚úÖ Loaded: ${filename} (${content.length} chars)`);
                        } else {
                            console.warn(`‚ö†Ô∏è Empty content for: ${filename}`);
                            failedFiles.push(filename);
                        }
                    } else {
                        console.error(`‚ùå HTTP ${response.status} for: ${filename}`);
                        failedFiles.push(filename);
                    }
                } catch (error) {
                    console.error(`‚ùå Network error loading ${filename}:`, error.message);
                    failedFiles.push(filename);
                }
            }
            
            console.log(`üìä Loading complete: ${loadedCount}/${exampleFilesList.length} files loaded`);
            
            if (failedFiles.length > 0) {
                console.warn(`‚ö†Ô∏è Failed files:`, failedFiles);
                
                // Fallback: create minimal templates for failed files
                failedFiles.forEach(filename => {
                    if (!window.exampleTemplates[filename]) {
                        window.exampleTemplates[filename] = `# ${filename}\n# This file could not be loaded from the server\n# Please check the server configuration\n\nprint("Hello from ${filename}")`;
                        console.log(`üîß Created fallback template for: ${filename}`);
                    }
                });
            }
            
            // Ensure we have at least one file available
            if (Object.keys(window.exampleTemplates).length === 0) {
                console.log('üÜò No files available, creating emergency welcome file');
                window.exampleTemplates['welcome.py'] = `# Ê¨¢ËøéÊù•Âà∞PythonÂú®Á∫øÁºñÁ®ãÁéØÂ¢ÉÔºÅ
# Welcome to Python Online IDE!

print("‰Ω†Â•ΩÔºå‰∏ñÁïåÔºÅ")  # Hello, World! in Chinese
print("Hello, World!")

# Ëøô‰∏™Êñá‰ª∂ÊòØ‰ªéÂ∫îÊÄ•ÂêéÂ§áÁ≥ªÁªüÂä†ËΩΩÁöÑ
# This file was loaded from the emergency fallback system
print("PythonÁºñÁ®ãÂ≠¶‰π†ÂºÄÂßã‰∫ÜÔºÅ")
print("Python programming learning begins!")`;
            }
            
            // Update the exampleFiles array with successfully loaded (or fallback) files
            window.exampleFiles = Object.keys(window.exampleTemplates);
            console.log(`üìÅ Available files: ${window.exampleFiles.length}`);
            
            // Update file tree after loading
            if (window.updateFileTree) {
                window.updateFileTree();
                console.log('üå≥ File tree updated');
            } else {
                console.error('‚ùå updateFileTree function not available');
            }
            
            // Validate global state
            console.log('üîç Global state check:');
            console.log('  - window.exampleFiles:', window.exampleFiles.length, 'items');
            console.log('  - window.exampleTemplates:', Object.keys(window.exampleTemplates).length, 'templates');
            console.log('  - First file content length:', window.exampleTemplates[window.exampleFiles[0]]?.length || 'N/A');
            
            return window.exampleTemplates;
        }
        // Dynamic template loading will handle welcome.py and all other templates
        // addTemplate calls removed - using dynamic loading instead
        
        // Templates now loaded safely above

        // Initialize Monaco Editor with better error handling
        async function initMonacoEditor() {
            try {
                // Wait for example files to be loaded first
                console.log('Waiting for example files before initializing editor...');
                let attempts = 0;
                while ((!window.exampleTemplates || Object.keys(window.exampleTemplates).length === 0) && attempts < 50) {
                    await new Promise(resolve => setTimeout(resolve, 100));
                    attempts++;
                }
                
                if (!window.exampleTemplates || Object.keys(window.exampleTemplates).length === 0) {
                    console.error('Example files not loaded after 5 seconds, using fallback');
                    createFallbackEditor();
                    return;
                }
                
                console.log('Example files loaded, initializing Monaco...');
                
                if (typeof require === 'undefined') {
                    console.error('RequireJS not loaded, using fallback editor');
                    createFallbackEditor();
                    return;
                }
                
                require.config({ paths: { vs: 'https://cdn-jsdelivr-net.jiasu.yunbiyun.com/npm/monaco-editor@0.52.2/min/vs' } });
                require(['vs/editor/editor.main'], function() {
                    try {
                        editor = monaco.editor.create(document.getElementById('editor'), {
                            value: '',
                            language: 'python',
                            theme: 'vs-dark',
                            automaticLayout: true,
                            minimap: { enabled: false },
                            fontSize: 14
                        });
                        
                        console.log('Monaco editor initialized successfully');
                        
                        // Make editor globally accessible
                        window.editor = editor;
                        
                        // Load welcome file initially - now safe because templates are loaded
                        window.loadFile('welcome.py');
                        
                    } catch (error) {
                        console.error('Monaco editor creation failed:', error);
                        createFallbackEditor();
                    }
                }, function(error) {
                    console.error('Monaco editor module loading failed:', error);
                    createFallbackEditor();
                });
                
            } catch (error) {
                console.error('Monaco editor initialization failed:', error);
                createFallbackEditor();
            }
        }
        
        async function createFallbackEditor() {
            console.log('Creating fallback textarea editor');
            const editorContainer = document.getElementById('editor');
            editorContainer.innerHTML = '<textarea id="fallback-editor" style="width:100%;height:100%;background:#1e1e1e;color:#d4d4d4;border:none;font-family:monospace;font-size:14px;padding:10px;resize:none;"></textarea>';
            const fallbackEditor = document.getElementById('fallback-editor');
            
            // Create a simple editor object to match Monaco's interface
            editor = {
                setValue: (value) => { fallbackEditor.value = value; },
                getValue: () => fallbackEditor.value,
                layout: () => {}
            };
            
            // Make editor globally accessible
            window.editor = editor;
            
            console.log('Fallback editor created');
            
            // Wait for templates to be available before loading welcome file
            if (window.exampleTemplates && window.exampleTemplates['welcome.py']) {
                window.loadFile('welcome.py');
            } else {
                console.log('Templates not ready, will load welcome.py when available');
                // Set up a watcher to load when ready
                const checkInterval = setInterval(() => {
                    if (window.exampleTemplates && window.exampleTemplates['welcome.py']) {
                        clearInterval(checkInterval);
                        window.loadFile('welcome.py');
                    }
                }, 500);
            }
        }

        // Replace the early loadFile function with full implementation
        window.loadFile = function loadFile(filename) {
            console.log('loadFile called with:', filename);
            
            // Load content if not already loaded
            if (!window.files.has(filename) && window.exampleTemplates[filename]) {
                window.files.set(filename, window.exampleTemplates[filename]);
                console.log('Loaded content for:', filename, 'Length:', window.exampleTemplates[filename].length);
            } else if (!window.exampleTemplates[filename]) {
                console.error('No template found for:', filename);
                return;
            }
            
            // Manage tab limits
            if (!window.openTabs.includes(filename)) {
                if (window.openTabs.length >= maxOpenTabs) {
                    const oldestTab = window.openTabs.shift();
                    cleanupFile(oldestTab);
                }
                window.openTabs.push(filename);
            }
            
            window.currentFile = filename;
            
            // Try to set editor content with fallback
            const content = window.files.get(filename) || '';
            if (window.editor && window.editor.setValue) {
                try {
                    window.editor.setValue(content);
                    console.log('Editor content set successfully');
                } catch (error) {
                    console.error('Error setting editor content:', error);
                }
            } else {
                console.log('Editor not ready, waiting...');
                // Wait for editor to be ready
                let attempts = 0;
                const waitForEditor = setInterval(() => {
                    attempts++;
                    if (window.editor && window.editor.setValue) {
                        try {
                            window.editor.setValue(content);
                            console.log('Editor content set after waiting');
                            clearInterval(waitForEditor);
                        } catch (error) {
                            console.error('Error setting editor content after waiting:', error);
                            clearInterval(waitForEditor);
                        }
                    } else if (attempts > 50) { // 5 seconds max
                        console.error('Editor never became ready');
                        clearInterval(waitForEditor);
                    }
                }, 100);
            }
            
            updateTabs();
            window.updateFileTree();
            updateMemoryInfo();
            
            console.log('loadFile completed. Current file:', window.currentFile, 'Files in memory:', window.files.size);
        };

        // Clean up file content when tab is closed
        function cleanupFile(filename) {
            if (window.exampleTemplates[filename] && filename !== window.currentFile) {
                window.files.delete(filename);
            }
            updateMemoryInfo();
        }

        // Memory management
        function updateMemoryInfo() {
            const memUsage = (window.files.size * 2 + terminalLineCount * 0.1).toFixed(1);
            memoryInfo.textContent = `Memory: ${memUsage} KB`;
        }

        function clearMemory() {
            // Clear all files except current
            const currentContent = window.files.get(window.currentFile);
            window.files.clear();
            if (window.currentFile && currentContent) {
                window.files.set(window.currentFile, currentContent);
            }
            
            // Clear terminal
            clearTerminal();
            
            // Close all tabs except current
            if (window.currentFile) {
                window.openTabs = [window.currentFile];
            } else {
                window.openTabs = [];
            }
            
            updateTabs();
            updateMemoryInfo();
            addTerminalOutput('‚ú® Memory cleared!', 'success');
        }

        function addTerminalOutput(text, className = '') {
            // Limit terminal history
            if (terminalLineCount >= maxTerminalLines) {
                const lines = terminalOutput.children;
                while (lines.length > maxTerminalLines * 0.8) {
                    terminalOutput.removeChild(lines[0]);
                    terminalLineCount--;
                }
            }
            
            const line = document.createElement('div');
            line.textContent = text;
            line.className = 'output' + (className ? ' ' + className : '');
            // Ensure empty lines have height for proper spacing
            if (text === '') {
                line.innerHTML = '&nbsp;'; // Non-breaking space to maintain line height
            }
            terminalOutput.appendChild(line);
            
            // Scroll to bottom to show new output
            scrollTerminalToBottom();
            
            terminalLineCount++;
            updateMemoryInfo();
            
            // Debug logging (controlled by debugMode flag)
            if (debugMode) {
                const terminal = document.getElementById('terminal');
                if (terminalLineCount % 10 === 0) { // Every 10 lines
                    console.log('Terminal scroll debug:', {
                        offsetHeight: terminal.offsetHeight,
                        scrollHeight: terminal.scrollHeight,
                        clientHeight: terminal.clientHeight,
                        needsScroll: terminal.scrollHeight > terminal.clientHeight,
                        computedHeight: window.getComputedStyle(terminal).height,
                        overflow: window.getComputedStyle(terminal).overflowY
                    });
                }
            }
        }

        async function initPython() {
            try {
                addTerminalOutput('Initializing Python environment...', 'info');
                
                // Add debug logging
                console.log('Checking Pyodide availability...');
                console.log('typeof loadPyodide:', typeof loadPyodide);
                console.log('window.loadPyodide:', window.loadPyodide);
                
                if (typeof loadPyodide === 'undefined') {
                    addTerminalOutput('‚ùå Pyodide library not found', 'error');
                    addTerminalOutput('Checking CDN accessibility...', 'info');
                    throw new Error('Pyodide library not loaded. Check internet connection and CDN access.');
                }
                
                addTerminalOutput('Loading Pyodide from CDN...', 'info');
                
                try {
                    pyodide = await loadPyodide({
                        indexURL: "https://cdn-jsdelivr-net.jiasu.yunbiyun.com/pyodide/v0.27.7/full/"
                    });
                } catch (cdnError) {
                    console.error('Primary CDN failed:', cdnError);
                    addTerminalOutput('Primary CDN failed, trying alternative...', 'warning');
                    
                    // Try alternative CDN
                    try {
                        pyodide = await loadPyodide({
                            indexURL: "https://cdn.jsdelivr.net/pyodide/v0.27.7/full/"
                        });
                        addTerminalOutput('Loaded from alternative CDN', 'success');
                    } catch (altError) {
                        console.error('Alternative CDN also failed:', altError);
                        throw new Error('Unable to load Pyodide from any CDN');
                    }
                }

                addTerminalOutput('Pyodide loaded, setting up environment...', 'info');

                pyodide.runPython(`
                    import sys
                    import os
                    from js import console

                    os.makedirs('/home/user', exist_ok=True)
                    os.chdir('/home/user')
                    
                    class JSConsole:
                        def write(self, text):
                            console.log(text)
                            return len(text)
                        
                        def flush(self):
                            pass
                    
                    sys.stdout = JSConsole()
                    sys.stderr = JSConsole()
                `);

                const originalLog = console.log;
                console.log = function(text) {
                    if (text && text.trim()) {
                        addTerminalOutput(text, 'output');
                    }
                    originalLog.apply(console, arguments);
                };

                addTerminalOutput('‚úÖ Python environment loaded successfully!', 'success');
                addTerminalOutput('‚úÖ Memory-optimized version ready!', 'success');
                addTerminalOutput('‚úÖ You can now run Python code!', 'success');
                addTerminalOutput('');
                
                terminalInputLine.style.display = 'flex';
                terminalInput.focus();
                
                // Make pyodide globally accessible for debugging
                window.pyodide = pyodide;
                
            } catch (error) {
                addTerminalOutput('‚ùå Error loading Python: ' + error.message, 'error');
                addTerminalOutput('üí° Try refreshing the page or check your internet connection.', 'info');
                console.error('Pyodide initialization error:', error);
            }
        }

        async function runCode() {
            if (!pyodide) {
                addTerminalOutput('Python environment not ready yet', 'error');
                return;
            }

            const code = editor.getValue();
            saveFile();
            
            addTerminalOutput(''); // Add a blank line for separation
            addTerminalOutput(`‚ñ∂Ô∏è Running ${window.currentFile}...`, 'running');
            // Force scroll to the bottom when running code
            scrollTerminalToBottom(true);
            
            try {
                pyodide.FS.writeFile(`/home/user/${window.currentFile}`, code);
                await pyodide.runPythonAsync(code);
            } catch (error) {
                addTerminalOutput(error.message, 'error');
            }
            
            addTerminalOutput('');
            
            // Force scroll to show the latest output after code execution
            scrollTerminalToBottom(true);
        }
        
        // Helper function to scroll terminal to bottom
        function scrollTerminalToBottom(force = false) {
            const terminal = document.getElementById('terminal');
            if (!terminal) return;

            // Check if we're near the bottom (within 20px)
            const nearBottom = terminal.scrollTop + terminal.clientHeight >= terminal.scrollHeight - 20;

            // Only scroll if forced or if we're already near the bottom
            if (force || nearBottom) {
                terminal.scrollTop = terminal.scrollHeight;
            }
        }

        async function executeTerminalCommand(command) {
            addTerminalOutput('>>> ' + command, 'command');
            
            try {
                if (command.trim() === 'clear') {
                    clearTerminal();
                    return;
                }
                
                if (command.trim() === 'ls') {
                    const files = Array.from(window.files.keys());
                    if (files.length === 0) {
                        addTerminalOutput('No files loaded');
                    } else {
                        files.forEach(file => addTerminalOutput(file));
                    }
                    return;
                }
                
                if (command.trim() === 'memory') {
                    addTerminalOutput(`Files in memory: ${window.files.size}`);
                    addTerminalOutput(`Open tabs: ${window.openTabs.length}/${maxOpenTabs}`);
                    addTerminalOutput(`Terminal lines: ${terminalLineCount}/${maxTerminalLines}`);
                    return;
                }
                
                let result = await pyodide.runPythonAsync(command);
                if (result !== undefined && result !== null) {
                    addTerminalOutput(String(result));
                }
            } catch (error) {
                addTerminalOutput(error.message, 'error');
            }
        }

        function newFile() {
            document.getElementById('newFileModal').style.display = 'block';
            document.getElementById('newFileName').focus();
        }

        function createFile() {
            const fileName = document.getElementById('newFileName').value.trim();
            if (!fileName) return;
            
            if (!fileName.endsWith('.py')) {
                alert('Please use .py extension for Python files');
                return;
            }
            
            if (window.files.has(fileName)) {
                alert('File already exists');
                return;
            }
            
            window.files.set(fileName, '# ' + fileName + '\\n\\n');
            loadFile(fileName);
            closeModal();
            updateFileTree();
        }

        function saveFile() {
            if (window.currentFile) {
                window.files.set(window.currentFile, editor.getValue());
                addTerminalOutput(`üíæ Saved ${window.currentFile}`, 'success');
                
                if (pyodide) {
                    try {
                        pyodide.FS.writeFile(`/home/user/${window.currentFile}`, editor.getValue());
                    } catch (error) {
                        console.error('Error saving to filesystem:', error);
                    }
                }
            }
        }

        function openTab(fileName) {
            loadFile(fileName);
        }

        function closeTab(fileName, event) {
            event.stopPropagation();
            const index = window.openTabs.indexOf(fileName);
            if (index > -1) {
                window.openTabs.splice(index, 1);
                cleanupFile(fileName);
            }
            
            if (window.currentFile === fileName && window.openTabs.length > 0) {
                loadFile(window.openTabs[window.openTabs.length - 1]);
            } else if (window.openTabs.length === 0) {
                window.currentFile = null;
                editor.setValue('');
                updateTabs();
                updateFileTree();
            }
        }

        function updateTabs() {
            const tabsContainer = document.getElementById('tabs');
            tabsContainer.innerHTML = '';
            
            window.openTabs.forEach(fileName => {
                const tab = document.createElement('div');
                tab.className = 'tab' + (fileName === window.currentFile ? ' active' : '');
                tab.onclick = () => openTab(fileName);
                
                tab.innerHTML = `
                    <span>${fileName}</span>
                    <span class="tab-close" onclick="closeTab('${fileName}', event)">√ó</span>
                `;
                
                tabsContainer.appendChild(tab);
            });
        }

        // Replace the early updateFileTree function with full implementation
        window.updateFileTree = function updateFileTree() {
            const fileTree = document.getElementById('file-tree');
            fileTree.innerHTML = '';
            
            window.exampleFiles.forEach(fileName => {
                const li = document.createElement('li');
                li.className = 'file-item' + (fileName === window.currentFile ? ' active' : '');
                li.onclick = () => loadFile(fileName);
                
                const isLoaded = window.files.has(fileName);
                const icon = isLoaded ? 'üìÑ' : 'üìã';
                li.innerHTML = `<span class="file-icon">${icon}</span> ${fileName}`;
                fileTree.appendChild(li);
            });
        };

        function clearTerminal() {
            terminalOutput.innerHTML = '';
            terminalLineCount = 0;
            updateMemoryInfo();
        }

        function closeModal() {
            document.getElementById('newFileModal').style.display = 'none';
            document.getElementById('newFileName').value = '';
        }

        // Terminal input handler
        terminalInput.addEventListener('keydown', async (e) => {
            if (e.key === 'Enter') {
                const command = terminalInput.value.trim();
                if (command) {
                    terminalInput.value = '';
                    await executeTerminalCommand(command);
                }
            }
        });

        // Modal handlers
        document.getElementById('newFileName').addEventListener('keydown', (e) => {
            if (e.key === 'Enter') {
                createFile();
            } else if (e.key === 'Escape') {
                closeModal();
            }
        });

        // Resize handler
        let isResizing = false;
        let resizeMode = 'horizontal'; // 'horizontal' or 'vertical'
        const resizeHandle = document.getElementById('resize-handle');
        const editorDiv = document.getElementById('editor');
        const terminalContainer = document.getElementById('terminal-container');
        const editorContainer = document.getElementById('editor-container');

        // Update resize mode based on screen width
        function updateResizeMode() {
            if (window.innerWidth <= 768) {
                resizeMode = 'vertical';
                resizeHandle.className = 'resize-handle vertical';
            } else {
                resizeMode = 'horizontal';
                resizeHandle.className = 'resize-handle horizontal';
            }
        }

        resizeHandle.addEventListener('mousedown', (e) => {
            isResizing = true;
            document.body.style.cursor = resizeMode === 'horizontal' ? 'col-resize' : 'row-resize';
            e.preventDefault();
        });

        document.addEventListener('mousemove', (e) => {
            if (!isResizing) return;
            
            if (resizeMode === 'horizontal') {
                const containerWidth = editorContainer.offsetWidth;
                const newEditorWidth = e.clientX - editorDiv.offsetLeft;
                const percentage = (newEditorWidth / containerWidth) * 100;
                
                if (percentage > 20 && percentage < 80) {
                    editorDiv.style.width = percentage + '%';
                    terminalContainer.style.width = (100 - percentage) + '%';
                    editor.layout();
                }
            } else {
                // Vertical resizing
                const containerHeight = editorContainer.offsetHeight;
                const editorTop = editorDiv.getBoundingClientRect().top;
                const newEditorHeight = e.clientY - editorTop;
                const percentage = (newEditorHeight / containerHeight) * 100;
                
                if (percentage > 20 && percentage < 80) {
                    editorDiv.style.height = percentage + '%';
                    terminalContainer.style.height = (100 - percentage) + '%';
                    editor.layout();
                    refreshTerminalLayout();
                }
            }
        });

        document.addEventListener('mouseup', () => {
            if (isResizing) {
                isResizing = false;
                document.body.style.cursor = 'default';
                editor.layout();
                refreshTerminalLayout();
            }
        });
        
        // Touch support for mobile resizing
        resizeHandle.addEventListener('touchstart', (e) => {
            isResizing = true;
            e.preventDefault();
        });
        
        document.addEventListener('touchmove', (e) => {
            if (!isResizing) return;
            
            const touch = e.touches[0];
            
            if (resizeMode === 'vertical') {
                const containerHeight = editorContainer.offsetHeight;
                const editorTop = editorDiv.getBoundingClientRect().top;
                const newEditorHeight = touch.clientY - editorTop;
                const percentage = (newEditorHeight / containerHeight) * 100;
                
                if (percentage > 20 && percentage < 80) {
                    editorDiv.style.height = percentage + '%';
                    terminalContainer.style.height = (100 - percentage) + '%';
                    editor.layout();
                    refreshTerminalLayout();
                }
            }
        });
        
        document.addEventListener('touchend', () => {
            if (isResizing) {
                isResizing = false;
                editor.layout();
                refreshTerminalLayout();
            }
        });

        // Mobile sidebar toggle
        function toggleMobileSidebar() {
            const sidebar = document.getElementById('sidebar');
            const overlay = document.querySelector('.mobile-overlay');
            sidebar.classList.toggle('mobile-open');
            overlay.classList.toggle('active');
        }
        
        function closeMobileSidebar() {
            const sidebar = document.getElementById('sidebar');
            const overlay = document.querySelector('.mobile-overlay');
            sidebar.classList.remove('mobile-open');
            overlay.classList.remove('active');
        }
        
        // Layout toggle function (no longer needed for mobile)
        function toggleLayout() {
            // This function is kept for the button but doesn't do anything on mobile
            // The layout automatically adjusts based on screen size
        }
        
        // Close sidebar when clicking on a file (mobile)
        const originalLoadFile = window.loadFile;
        window.loadFile = function(filename) {
            if (window.innerWidth <= 768) {
                closeMobileSidebar();
            }
            return originalLoadFile.call(this, filename);
        };
        
        // Initialize templates and file tree on page load
        document.addEventListener('DOMContentLoaded', async function() {
            console.log('üöÄ DOMContentLoaded fired - initializing application');
            
            // Validate DOM elements are ready
            const fileTree = document.getElementById('file-tree');
            if (!fileTree) {
                console.error('‚ùå Critical DOM elements not found');
                return;
            }
            
            console.log('‚úÖ DOM elements validated');
            
            try {
                // Load example files dynamically first
                console.log('üîÑ Starting loadExampleFiles...');
                await loadExampleFiles();
                console.log('‚úÖ Example files loaded successfully');
                
                // Validate the results
                if (window.exampleFiles.length === 0) {
                    console.warn('‚ö†Ô∏è No example files were loaded - entering recovery mode');
                    await attemptRecovery();
                }
                
                // Now that files are loaded, initialize the editor
                console.log('üîÑ Initializing editor...');
                await initMonacoEditor();
                console.log('‚úÖ Editor initialization complete');
                
                // Refresh terminal layout after initialization
                setTimeout(() => {
                    updateResizeMode();
                    refreshTerminalLayout();
                }, 500);
                
            } catch (error) {
                console.error('‚ùå Error during initialization:', error);
                await attemptRecovery();
            }
        });
        
        // Recovery function for when dynamic loading fails
        async function attemptRecovery() {
            console.log('üîß Attempting recovery...');
            
            // Try loading again after a delay
            setTimeout(async function() {
                try {
                    console.log('üîÑ Retry attempt 1...');
                    await loadExampleFiles();
                    
                    if (window.exampleFiles.length > 0) {
                        console.log('‚úÖ Recovery successful via retry');
                        return;
                    }
                } catch (retryError) {
                    console.error('‚ùå Retry failed:', retryError);
                }
                
                // Ultimate fallback: create static templates
                console.log('üÜò Creating static fallback templates');
                createStaticFallback();
                
            }, 2000);
        }
        
        // Static fallback when all dynamic loading fails
        function createStaticFallback() {
            console.log('üìù Creating static template fallbacks');
            
            const staticFiles = {
                'welcome.py': `# Welcome to Python Online IDE!
# This is a fallback template - server files could not be loaded

print("Welcome to Python!")
print("This IDE lets you write and run Python code in your browser.")
print("Try editing this code and clicking 'Run' to see the results!")

# Example: Basic calculations
x = 10
y = 5
print(f"x + y = {x + y}")
print(f"x * y = {x * y}")`,

                '01_hello_world.py': `# Hello World Example
# This is a fallback template

print("Hello, World!")
print("This is your first Python program!")

# Try changing the message below
message = "Python is awesome!"
print(message)`,

                '02_variables.py': `# Variables Example
# This is a fallback template

# Different types of variables
name = "Alice"
age = 25
height = 5.6
is_student = True

print(f"Name: {name}")
print(f"Age: {age}")
print(f"Height: {height} feet")
print(f"Is student: {is_student}")`
            };
            
            // Create templates
            Object.entries(staticFiles).forEach(([filename, content]) => {
                window.exampleTemplates[filename] = content;
                console.log(`üìÑ Created static template: ${filename}`);
            });
            
            // Update arrays
            window.exampleFiles = Object.keys(window.exampleTemplates);
            
            // Update UI
            if (window.updateFileTree) {
                window.updateFileTree();
                console.log('üå≥ File tree updated with static templates');
            }
            
            console.log(`‚úÖ Static fallback complete: ${window.exampleFiles.length} files available`);
        }

        // Test terminal scroll function
        window.testTerminalScroll = function() {
            console.log('=== Starting scroll test ===');
            for(let i = 0; i < 100; i++) {
                addTerminalOutput(`Test line ${i + 1}: This is a test line with enough text to ensure it takes up some space in the terminal. Testing scrollbar functionality.`);
            }
            const terminal = document.getElementById('terminal');
            console.log('=== Final scroll state ===', {
                scrollHeight: terminal.scrollHeight,
                clientHeight: terminal.clientHeight,
                hasVerticalScroll: terminal.scrollHeight > terminal.clientHeight,
                scrollbarVisible: terminal.scrollHeight > terminal.offsetHeight
            });
        };

        // Force terminal layout refresh
        function refreshTerminalLayout() {
            const terminal = document.getElementById('terminal');
            const terminalContainer = document.getElementById('terminal-container');
            
            // Force recalculate height
            terminal.style.height = '0';
            const containerHeight = terminalContainer.clientHeight - document.getElementById('terminal-header').offsetHeight;
            terminal.style.height = '';
            
            // Trigger reflow
            void terminal.offsetHeight;
            
            console.log('Terminal layout refreshed');
        }

        // Visual scrollbar check
        window.checkScrollbar = function() {
            const terminal = document.getElementById('terminal');
            const hasScroll = terminal.scrollHeight > terminal.clientHeight;
            
            if (hasScroll) {
                terminal.style.border = '2px solid green';
                console.log('‚úÖ Scrollbar should be visible');
            } else {
                terminal.style.border = '2px solid red';
                console.log('‚ùå No scrollbar needed - adding more content...');
                // Auto-add more content
                for(let i = 0; i < 50; i++) {
                    addTerminalOutput(`Auto-added line ${i + 1} to trigger scrollbar`);
                }
            }
            
            return {
                scrollHeight: terminal.scrollHeight,
                clientHeight: terminal.clientHeight,
                offsetHeight: terminal.offsetHeight,
                hasScroll: hasScroll
            };
        };

        // Listen for resize
        window.addEventListener('resize', () => {
            updateResizeMode();
            refreshTerminalLayout();
            if (editor && editor.layout) {
                editor.layout();
            }
        });

        // Initialize Python when page loads with error handling
        window.addEventListener('load', () => {
            console.log('Window loaded, checking Pyodide script...');
            
            // Check if Pyodide script tag exists
            const pyodideScript = document.querySelector('script[src*="pyodide.js"]');
            console.log('Pyodide script tag:', pyodideScript);
            
            // Wait a bit for script to load, then initialize
            setTimeout(() => {
                console.log('Attempting to initialize Python...');
                initPython().catch(error => {
                    console.error('Failed to initialize Python:', error);
                    addTerminalOutput('‚ùå Failed to initialize Python environment', 'error');
                    addTerminalOutput('Please check browser console for details', 'error');
                });
            }, 1000);
            
            // Layout check
            setTimeout(() => {
                const terminal = document.getElementById('terminal');
                const terminalContainer = document.getElementById('terminal-container');
                console.log('Layout check:', {
                    terminalContainer: {
                        height: terminalContainer.offsetHeight,
                        flex: window.getComputedStyle(terminalContainer).flex
                    },
                    terminal: {
                        height: terminal.offsetHeight,
                        flex: window.getComputedStyle(terminal).flex,
                        overflow: window.getComputedStyle(terminal).overflowY
                    }
                });
            }, 2000);
        });
        
        // Debug function to test global state (accessible from browser console)
        window.debugGlobalState = function() {
            console.log('=== GLOBAL STATE DEBUG ===');
            console.log('window.exampleFiles:', window.exampleFiles);
            console.log('window.exampleFiles.length:', window.exampleFiles ? window.exampleFiles.length : 'undefined');
            console.log('window.exampleTemplates:', window.exampleTemplates);
            console.log('window.exampleTemplates keys:', window.exampleTemplates ? Object.keys(window.exampleTemplates) : 'undefined');
            console.log('window.files:', window.files);
            console.log('window.files.size:', window.files ? window.files.size : 'undefined');
            console.log('window.currentFile:', window.currentFile);
            console.log('window.openTabs:', window.openTabs);
            console.log('loadExampleFiles function:', typeof loadExampleFiles);
            console.log('updateFileTree function:', typeof window.updateFileTree);
            console.log('========================');
            
            // Test if the file tree has content
            const fileTree = document.getElementById('file-tree');
            if (fileTree) {
                console.log('File tree DOM children:', fileTree.children.length);
                console.log('File tree innerHTML length:', fileTree.innerHTML.length);
            }
            
            return {
                exampleFiles: window.exampleFiles,
                exampleTemplates: Object.keys(window.exampleTemplates || {}),
                filesInMemory: window.files ? window.files.size : 0,
                currentFile: window.currentFile,
                openTabs: window.openTabs,
                fileTreeChildren: fileTree ? fileTree.children.length : 0
            };
        };
        
        // Debug mode control functions
        window.enableDebug = function() {
            debugMode = true;
            console.log('‚úÖ Debug mode ENABLED - Terminal scroll debug messages will appear every 10 lines');
            return 'Debug mode is now ON';
        };
        
        window.disableDebug = function() {
            debugMode = false;
            console.log('‚ùå Debug mode DISABLED - Terminal scroll debug messages will not appear');
            return 'Debug mode is now OFF';
        };
        
        window.toggleDebug = function() {
            debugMode = !debugMode;
            console.log(debugMode ? '‚úÖ Debug mode ENABLED' : '‚ùå Debug mode DISABLED');
            return `Debug mode is now ${debugMode ? 'ON' : 'OFF'}`;
        };
        
        console.log('üí° Debug tips:');
        console.log('   - window.enableDebug()  : Turn on debug mode');
        console.log('   - window.disableDebug() : Turn off debug mode');
        console.log('   - window.toggleDebug()  : Toggle debug mode');
        console.log('   - window.debugGlobalState() : Check global state');
    </script>
    
    <!-- Mobile overlay -->
    <div class="mobile-overlay" onclick="closeMobileSidebar()"></div>
    
    <!-- Footer -->
    <div class="footer">
        <div class="footer-item">
            <a href="#" class="footer-contact" id="footer-contact">
                ËÅîÁ≥ªÂèçÈ¶à
                <div class="qr-tooltip">
                    <img src="https://yunbiyun.com/qiyeweixin.png" alt="‰ºÅ‰∏öÂæÆ‰ø°‰∫åÁª¥Á†Å">
                </div>
            </a>
        </div>
        <div class="footer-item footer-copyright">
            ¬© 2025 ÂπøÂ∑û‰∫ëÊÄù‰ø°ÊÅØÊäÄÊúØÊúâÈôêÂÖ¨Âè∏
        </div>
        <div class="footer-item">
            <a href="https://beian.miit.gov.cn" target="_blank" class="footer-icp">Á≤§ICPÂ§á19043749Âè∑-4</a>
        </div>
        <div class="footer-item">
            <a href="https://github.com/huangsen365/python-wasm-demo" target="_blank" class="footer-link">GitHub</a>
        </div>
    </div>

    <script>
        // Footer contact click handler
        document.getElementById('footer-contact').addEventListener('click', function(e) {
            e.preventDefault();
            this.classList.toggle('active');
        });
        
        // Close QR code when clicking outside
        document.addEventListener('click', function(e) {
            const contact = document.getElementById('footer-contact');
            if (!contact.contains(e.target)) {
                contact.classList.remove('active');
            }
        });
    </script>
</body>

</html>
