<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Python Online IDE</title>
    <link rel="stylesheet" data-name="vs/editor/editor.main" href="https://cdn-jsdelivr-net.jiasu.yunbiyun.com/npm/monaco-editor@0.45.0/min/vs/editor/editor.main.css">
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #1e1e1e;
            color: #d4d4d4;
            height: 100vh;
            display: flex;
            flex-direction: column;
        }

        #header {
            background-color: #2d2d30;
            padding: 10px 20px;
            display: flex;
            align-items: center;
            gap: 20px;
            border-bottom: 1px solid #3e3e42;
        }

        #header h1 {
            font-size: 20px;
            font-weight: normal;
            color: #cccccc;
        }

        .toolbar {
            display: flex;
            gap: 10px;
            margin-left: auto;
        }

        .btn {
            background-color: #0e639c;
            color: white;
            border: none;
            padding: 6px 12px;
            border-radius: 3px;
            cursor: pointer;
            font-size: 14px;
            transition: background-color 0.2s;
        }

        .btn:hover {
            background-color: #1177bb;
        }

        .btn:disabled {
            background-color: #3e3e42;
            cursor: not-allowed;
        }

        .btn-success {
            background-color: #4ec9b0;
        }

        .btn-success:hover {
            background-color: #3ca08a;
        }

        .btn-warning {
            background-color: #d19a66;
        }

        .btn-warning:hover {
            background-color: #b8864f;
        }

        #main-container {
            flex: 1;
            display: flex;
            overflow: hidden;
        }

        #sidebar {
            width: 200px;
            background-color: #252526;
            border-right: 1px solid #3e3e42;
            display: flex;
            flex-direction: column;
        }

        #file-explorer {
            flex: 1;
            overflow-y: auto;
            padding: 10px;
        }

        .file-tree {
            list-style: none;
        }

        .file-item {
            padding: 4px 8px;
            cursor: pointer;
            border-radius: 3px;
            display: flex;
            align-items: center;
            gap: 5px;
            user-select: none;
        }

        .file-item:hover {
            background-color: #2a2d2e;
        }

        .file-item.active {
            background-color: #094771;
        }

        .file-icon {
            width: 16px;
            height: 16px;
            display: inline-block;
        }

        #content {
            flex: 1;
            display: flex;
            flex-direction: column;
        }

        #tabs {
            background-color: #2d2d30;
            display: flex;
            border-bottom: 1px solid #3e3e42;
            overflow-x: auto;
        }

        .tab {
            padding: 8px 16px;
            cursor: pointer;
            border-right: 1px solid #3e3e42;
            display: flex;
            align-items: center;
            gap: 8px;
            white-space: nowrap;
        }

        .tab:hover {
            background-color: #323233;
        }

        .tab.active {
            background-color: #1e1e1e;
            border-bottom: 2px solid #007acc;
        }

        .tab-close {
            margin-left: 5px;
            cursor: pointer;
            opacity: 0.6;
        }

        .tab-close:hover {
            opacity: 1;
        }

        #editor-container {
            flex: 1;
            display: flex;
        }

        #editor {
            flex: 1;
        }

        #terminal-container {
            width: 40%;
            background-color: #1e1e1e;
            border-left: 1px solid #3e3e42;
            display: flex;
            flex-direction: column;
        }

        #terminal-header {
            background-color: #2d2d30;
            padding: 8px 12px;
            border-bottom: 1px solid #3e3e42;
            font-size: 14px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        #terminal {
            flex: 1;
            padding: 10px;
            /* Show scroll bar when needed for easier navigation */
            overflow-y: auto;
            overflow-x: hidden;
            font-family: 'Consolas', 'Courier New', monospace;
            font-size: 14px;
            /* Enhanced scroll bar visibility */
            scrollbar-width: thin;
            scrollbar-color: #666 #2d2d30;
        }

        /* Enhanced scroll bar styling for WebKit browsers (Chrome, Safari, Edge) */
        #terminal::-webkit-scrollbar {
            width: 14px;
        }

        #terminal::-webkit-scrollbar-track {
            background: #2d2d30;
            border-radius: 7px;
            border: 1px solid #3e3e42;
        }

        #terminal::-webkit-scrollbar-thumb {
            background: #666;
            border-radius: 7px;
            border: 2px solid #2d2d30;
            min-height: 30px;
        }

        #terminal::-webkit-scrollbar-thumb:hover {
            background: #888;
        }

        #terminal::-webkit-scrollbar-thumb:active {
            background: #999;
        }

        /* Terminal scroll indicator when content overflows */
        #terminal {
            position: relative;
        }

        #terminal:hover::-webkit-scrollbar-thumb {
            background: #777;
        }

        #terminal-output {
            white-space: pre-wrap;
            word-wrap: break-word;
        }

        #terminal-input-line {
            display: flex;
            margin-top: 10px;
        }

        #terminal-prompt {
            color: #4ec9b0;
            margin-right: 5px;
        }

        #terminal-input {
            flex: 1;
            background: transparent;
            border: none;
            color: #d4d4d4;
            font-family: inherit;
            font-size: inherit;
            outline: none;
        }

        .loading {
            color: #dcdcaa;
        }

        .error {
            color: #f44747;
        }

        .success {
            color: #4ec9b0;
        }

        .output {
            color: #cccccc;
        }

        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
        }

        .modal-content {
            background-color: #2d2d30;
            margin: 20% auto;
            padding: 20px;
            border: 1px solid #3e3e42;
            width: 300px;
            border-radius: 5px;
        }

        .modal-content input {
            width: 100%;
            padding: 8px;
            margin: 10px 0;
            background-color: #1e1e1e;
            border: 1px solid #3e3e42;
            color: #d4d4d4;
            border-radius: 3px;
        }

        .modal-buttons {
            display: flex;
            gap: 10px;
            justify-content: flex-end;
            margin-top: 15px;
        }

        .resize-handle {
            width: 5px;
            background-color: #3e3e42;
            cursor: col-resize;
            position: relative;
        }

        .resize-handle:hover {
            background-color: #007acc;
        }

        .memory-info {
            font-size: 12px;
            opacity: 0.7;
        }
    </style>
</head>
<body>
    <div id="header">
        <h1>Python Online IDE</h1>
        <div class="toolbar">
            <button class="btn" onclick="newFile()">New File</button>
            <button class="btn" onclick="saveFile()">Save</button>
            <button class="btn btn-success" onclick="runCode()">▶ Run</button>
            <button class="btn" onclick="clearTerminal()">Clear Terminal</button>
            <button class="btn btn-warning" onclick="clearMemory()">Clear Memory</button>
        </div>
    </div>

    <div id="main-container">
        <div id="sidebar">
            <div id="file-explorer">
                <h3 style="margin-bottom: 10px; font-size: 14px;">FILES</h3>
                <ul id="file-tree" class="file-tree"></ul>
            </div>
        </div>

        <div id="content">
            <div id="tabs"></div>
            <div id="editor-container">
                <div id="editor"></div>
                <div class="resize-handle" id="resize-handle"></div>
                <div id="terminal-container">
                    <div id="terminal-header">
                        <span>TERMINAL</span>
                        <span class="memory-info" id="memory-info">Memory: 0 KB</span>
                    </div>
                    <div id="terminal">
                        <div id="terminal-output">
                            <div class="loading">Loading Python environment...</div>
                        </div>
                        <div id="terminal-input-line" style="display: none;">
                            <span id="terminal-prompt">&gt;&gt;&gt;</span>
                            <input type="text" id="terminal-input" autofocus>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- New File Modal -->
    <div id="newFileModal" class="modal">
        <div class="modal-content">
            <h3>New File</h3>
            <input type="text" id="newFileName" placeholder="filename.py">
            <div class="modal-buttons">
                <button class="btn" onclick="closeModal()">Cancel</button>
                <button class="btn btn-success" onclick="createFile()">Create</button>
            </div>
        </div>
    </div>

    <script src="https://cdn-jsdelivr-net.jiasu.yunbiyun.com/npm/monaco-editor@0.45.0/min/vs/loader.js"></script>
    <script src="https://cdn-jsdelivr-net.jiasu.yunbiyun.com/pyodide/v0.27.7/full/pyodide.js"></script>
    <script>
        // Initialize global variables immediately for testing accessibility
        window.currentFile = null;
        window.files = new Map();
        window.openTabs = [];
        window.exampleFiles = []; // Will be populated dynamically by loadExampleFiles()
        
        // exampleTemplates will be initialized later with full content
        
        // Initialize local variables
        let pyodide;
        let editor;
        let maxTerminalLines = 500;
        let maxOpenTabs = 3;
        let terminalLineCount = 0;
        
        // Initialize functions immediately for testing (proper implementation follows)
        window.loadFile = function(filename) {
            console.log('loadFile called early:', filename);
            // Will be replaced by full implementation
        };
        
        window.updateFileTree = function() {
            console.log('updateFileTree called early');
            const fileTree = document.getElementById('file-tree');
            if (fileTree && window.exampleFiles) {
                fileTree.innerHTML = '';
                window.exampleFiles.forEach(fileName => {
                    const li = document.createElement('li');
                    li.className = 'file-item' + (fileName === window.currentFile ? ' active' : '');
                    li.onclick = () => window.loadFile(fileName);
                    const isLoaded = window.files.has(fileName);
                    const icon = isLoaded ? '📄' : '📋';
                    li.innerHTML = `<span class="file-icon">${icon}</span> ${fileName}`;
                    fileTree.appendChild(li);
                });
                console.log('File tree populated with', window.exampleFiles.length, 'items');
            } else {
                console.error('File tree element or exampleFiles not found');
            }
        };

        // Library loading is now handled in specific initialization functions

        // Terminal elements
        const terminalOutput = document.getElementById('terminal-output');
        const terminalInput = document.getElementById('terminal-input');
        const terminalInputLine = document.getElementById('terminal-input-line');
        const memoryInfo = document.getElementById('memory-info');

        // Initialize global variables immediately and ensure they're available
        window.exampleTemplates = {};
        window.exampleFiles = [];
        window.files = new Map();
        window.openTabs = [];
        window.currentFile = null;
        
        console.log('🚀 JavaScript initializing - global variables set');
        
        // Immediately available stub functions to prevent "not found" errors
        window.loadFile = function(filename) {
            console.log('loadFile called early:', filename, '- will retry when templates are loaded');
            // If templates are loaded, defer to the full implementation
            if (window.exampleTemplates[filename]) {
                window.loadFile = window.loadFileReal || window.loadFile;
                return window.loadFile(filename);
            }
            // Otherwise, try again after a short delay
            setTimeout(() => window.loadFile(filename), 1000);
        };
        
        window.updateFileTree = function() {
            console.log('updateFileTree called early - will update when files are loaded');
            const fileTree = document.getElementById('file-tree');
            if (fileTree) {
                if (window.exampleFiles.length === 0) {
                    fileTree.innerHTML = '<li style="color: #888; padding: 10px;">Loading examples...</li>';
                } else {
                    // Defer to real implementation if available
                    if (window.updateFileTreeReal) {
                        return window.updateFileTreeReal();
                    }
                    // Basic implementation
                    fileTree.innerHTML = '';
                    window.exampleFiles.forEach(fileName => {
                        const li = document.createElement('li');
                        li.className = 'file-item';
                        li.onclick = () => window.loadFile(fileName);
                        li.innerHTML = `<span class="file-icon">📄</span> ${fileName}`;
                        fileTree.appendChild(li);
                    });
                }
            }
        };
        
        // Make these immediately available for tests
        window.globalReady = true;
        
        // Dynamic loading of Python example files
        async function loadExampleFiles() {
            const exampleFilesList = [
                'welcome.py',
                '01_hello_world.py', 
                '02_variables.py',
                '03_lists.py',
                '04_dictionaries.py',
                '05_control_flow.py',
                '06_loops.py',
                '07_functions.py',
                '08_classes.py',
                '09_errors.py',
                '10_modules.py'
            ];
            
            console.log('🔄 Loading Python example files...');
            
            let loadedCount = 0;
            let failedFiles = [];
            
            for (const filename of exampleFilesList) {
                try {
                    console.log(`📡 Fetching: /examples/${filename}`);
                    const response = await fetch(`/examples/${filename}`);
                    
                    if (response.ok) {
                        const content = await response.text();
                        if (content && content.trim().length > 0) {
                            window.exampleTemplates[filename] = content;
                            loadedCount++;
                            console.log(`✅ Loaded: ${filename} (${content.length} chars)`);
                        } else {
                            console.warn(`⚠️ Empty content for: ${filename}`);
                            failedFiles.push(filename);
                        }
                    } else {
                        console.error(`❌ HTTP ${response.status} for: ${filename}`);
                        failedFiles.push(filename);
                    }
                } catch (error) {
                    console.error(`❌ Network error loading ${filename}:`, error.message);
                    failedFiles.push(filename);
                }
            }
            
            console.log(`📊 Loading complete: ${loadedCount}/${exampleFilesList.length} files loaded`);
            
            if (failedFiles.length > 0) {
                console.warn(`⚠️ Failed files:`, failedFiles);
                
                // Fallback: create minimal templates for failed files
                failedFiles.forEach(filename => {
                    if (!window.exampleTemplates[filename]) {
                        window.exampleTemplates[filename] = `# ${filename}\n# This file could not be loaded from the server\n# Please check the server configuration\n\nprint("Hello from ${filename}")`;
                        console.log(`🔧 Created fallback template for: ${filename}`);
                    }
                });
            }
            
            // Ensure we have at least one file available
            if (Object.keys(window.exampleTemplates).length === 0) {
                console.log('🆘 No files available, creating emergency welcome file');
                window.exampleTemplates['welcome.py'] = `# 欢迎来到Python在线编程环境！
# Welcome to Python Online IDE!

print("你好，世界！")  # Hello, World! in Chinese
print("Hello, World!")

# 这个文件是从应急后备系统加载的
# This file was loaded from the emergency fallback system
print("Python编程学习开始了！")
print("Python programming learning begins!")`;
            }
            
            // Update the exampleFiles array with successfully loaded (or fallback) files
            window.exampleFiles = Object.keys(window.exampleTemplates);
            console.log(`📁 Available files: ${window.exampleFiles.length}`);
            
            // Update file tree after loading
            if (window.updateFileTree) {
                window.updateFileTree();
                console.log('🌳 File tree updated');
            } else {
                console.error('❌ updateFileTree function not available');
            }
            
            // Validate global state
            console.log('🔍 Global state check:');
            console.log('  - window.exampleFiles:', window.exampleFiles.length, 'items');
            console.log('  - window.exampleTemplates:', Object.keys(window.exampleTemplates).length, 'templates');
            console.log('  - First file content length:', window.exampleTemplates[window.exampleFiles[0]]?.length || 'N/A');
            
            return window.exampleTemplates;
        }
        // Dynamic template loading will handle welcome.py and all other templates
        // addTemplate calls removed - using dynamic loading instead
        
        // Templates now loaded safely above

        // Initialize Monaco Editor with better error handling
        function initMonacoEditor() {
            try {
                if (typeof require === 'undefined') {
                    console.error('RequireJS not loaded, using fallback editor');
                    createFallbackEditor();
                    return;
                }
                
                require.config({ paths: { vs: 'https://cdn-jsdelivr-net.jiasu.yunbiyun.com/npm/monaco-editor@0.45.0/min/vs' } });
                require(['vs/editor/editor.main'], function() {
                    try {
                        editor = monaco.editor.create(document.getElementById('editor'), {
                            value: '',
                            language: 'python',
                            theme: 'vs-dark',
                            automaticLayout: true,
                            minimap: { enabled: false },
                            fontSize: 14
                        });
                        
                        console.log('Monaco editor initialized successfully');
                        
                        // Make editor globally accessible
                        window.editor = editor;
                        
                        // Load welcome file initially
                        window.loadFile('welcome.py');
                        
                    } catch (error) {
                        console.error('Monaco editor creation failed:', error);
                        createFallbackEditor();
                    }
                }, function(error) {
                    console.error('Monaco editor module loading failed:', error);
                    createFallbackEditor();
                });
                
            } catch (error) {
                console.error('Monaco editor initialization failed:', error);
                createFallbackEditor();
            }
        }
        
        function createFallbackEditor() {
            console.log('Creating fallback textarea editor');
            const editorContainer = document.getElementById('editor');
            editorContainer.innerHTML = '<textarea id="fallback-editor" style="width:100%;height:100%;background:#1e1e1e;color:#d4d4d4;border:none;font-family:monospace;font-size:14px;padding:10px;resize:none;"></textarea>';
            const fallbackEditor = document.getElementById('fallback-editor');
            
            // Create a simple editor object to match Monaco's interface
            editor = {
                setValue: (value) => { fallbackEditor.value = value; },
                getValue: () => fallbackEditor.value,
                layout: () => {}
            };
            
            // Make editor globally accessible
            window.editor = editor;
            
            console.log('Fallback editor created');
            
            // Load welcome file
            window.loadFile('welcome.py');
        }
        
        // Try to initialize Monaco, with fallback after timeout
        initMonacoEditor();
        
        // Fallback timeout if Monaco takes too long
        setTimeout(() => {
            if (!window.editor) {
                console.log('Monaco editor timeout, creating fallback');
                createFallbackEditor();
            }
        }, 10000);

        // Replace the early loadFile function with full implementation
        window.loadFile = function loadFile(filename) {
            console.log('loadFile called with:', filename);
            
            // Load content if not already loaded
            if (!window.files.has(filename) && window.exampleTemplates[filename]) {
                window.files.set(filename, window.exampleTemplates[filename]);
                console.log('Loaded content for:', filename, 'Length:', window.exampleTemplates[filename].length);
            } else if (!window.exampleTemplates[filename]) {
                console.error('No template found for:', filename);
                return;
            }
            
            // Manage tab limits
            if (!window.openTabs.includes(filename)) {
                if (window.openTabs.length >= maxOpenTabs) {
                    const oldestTab = window.openTabs.shift();
                    cleanupFile(oldestTab);
                }
                window.openTabs.push(filename);
            }
            
            window.currentFile = filename;
            
            // Try to set editor content with fallback
            const content = window.files.get(filename) || '';
            if (window.editor && window.editor.setValue) {
                try {
                    window.editor.setValue(content);
                    console.log('Editor content set successfully');
                } catch (error) {
                    console.error('Error setting editor content:', error);
                }
            } else {
                console.log('Editor not ready, waiting...');
                // Wait for editor to be ready
                let attempts = 0;
                const waitForEditor = setInterval(() => {
                    attempts++;
                    if (window.editor && window.editor.setValue) {
                        try {
                            window.editor.setValue(content);
                            console.log('Editor content set after waiting');
                            clearInterval(waitForEditor);
                        } catch (error) {
                            console.error('Error setting editor content after waiting:', error);
                            clearInterval(waitForEditor);
                        }
                    } else if (attempts > 50) { // 5 seconds max
                        console.error('Editor never became ready');
                        clearInterval(waitForEditor);
                    }
                }, 100);
            }
            
            updateTabs();
            window.updateFileTree();
            updateMemoryInfo();
            
            console.log('loadFile completed. Current file:', window.currentFile, 'Files in memory:', window.files.size);
        };

        // Clean up file content when tab is closed
        function cleanupFile(filename) {
            if (window.exampleTemplates[filename] && filename !== window.currentFile) {
                window.files.delete(filename);
            }
            updateMemoryInfo();
        }

        // Memory management
        function updateMemoryInfo() {
            const memUsage = (window.files.size * 2 + terminalLineCount * 0.1).toFixed(1);
            memoryInfo.textContent = `Memory: ${memUsage} KB`;
        }

        function clearMemory() {
            // Clear all files except current
            const currentContent = window.files.get(window.currentFile);
            window.files.clear();
            if (window.currentFile && currentContent) {
                window.files.set(window.currentFile, currentContent);
            }
            
            // Clear terminal
            clearTerminal();
            
            // Close all tabs except current
            if (window.currentFile) {
                window.openTabs = [window.currentFile];
            } else {
                window.openTabs = [];
            }
            
            updateTabs();
            updateMemoryInfo();
            addTerminalOutput('Memory cleared!', 'success');
        }

        function addTerminalOutput(text, className = '') {
            // Limit terminal history
            if (terminalLineCount >= maxTerminalLines) {
                const lines = terminalOutput.children;
                while (lines.length > maxTerminalLines * 0.8) {
                    terminalOutput.removeChild(lines[0]);
                    terminalLineCount--;
                }
            }
            
            const line = document.createElement('div');
            line.textContent = text;
            if (className) line.className = className;
            terminalOutput.appendChild(line);
            
            // Auto-scroll to show new output using helper
            scrollTerminalToBottom();
            
            terminalLineCount++;
            updateMemoryInfo();
        }

        async function initPython() {
            try {
                addTerminalOutput('Initializing Python environment...', 'info');
                
                if (typeof loadPyodide === 'undefined') {
                    throw new Error('Pyodide library not loaded. Check internet connection.');
                }
                
                pyodide = await loadPyodide({
                    indexURL: "https://cdn-jsdelivr-net.jiasu.yunbiyun.com/pyodide/v0.27.7/full/"
                });

                addTerminalOutput('Pyodide loaded, setting up environment...', 'info');

                pyodide.runPython(`
                    import sys
                    import os
                    from js import console

                    os.makedirs('/home/user', exist_ok=True)
                    os.chdir('/home/user')
                    
                    class JSConsole:
                        def write(self, text):
                            console.log(text)
                            return len(text)
                        
                        def flush(self):
                            pass
                    
                    sys.stdout = JSConsole()
                    sys.stderr = JSConsole()
                `);

                const originalLog = console.log;
                console.log = function(text) {
                    if (text && text.trim()) {
                        addTerminalOutput(text, 'output');
                    }
                    originalLog.apply(console, arguments);
                };

                addTerminalOutput('✅ Python environment loaded successfully!', 'success');
                addTerminalOutput('✅ Memory-optimized version ready!', 'success');
                addTerminalOutput('✅ You can now run Python code!', 'success');
                addTerminalOutput('');
                
                terminalInputLine.style.display = 'flex';
                terminalInput.focus();
                
                // Make pyodide globally accessible for debugging
                window.pyodide = pyodide;
                
            } catch (error) {
                addTerminalOutput('❌ Error loading Python: ' + error.message, 'error');
                addTerminalOutput('💡 Try refreshing the page or check your internet connection.', 'info');
                console.error('Pyodide initialization error:', error);
            }
        }

        async function runCode() {
            if (!pyodide) {
                addTerminalOutput('Python environment not ready yet', 'error');
                return;
            }

            const code = editor.getValue();
            saveFile();
            
            addTerminalOutput(`\\n>>> Running ${window.currentFile}...`, 'success');
            // Scroll to the bottom so new output is visible immediately
            scrollTerminalToBottom();
            
            try {
                pyodide.FS.writeFile(`/home/user/${window.currentFile}`, code);
                await pyodide.runPythonAsync(code);
            } catch (error) {
                addTerminalOutput(error.message, 'error');
            }
            
            addTerminalOutput('');
            
            // Ensure terminal scrolls to show the latest output
            scrollTerminalToBottom();
        }
        
        // Helper function to scroll terminal to bottom
        function scrollTerminalToBottom() {
            const terminal = document.getElementById('terminal');
            if (terminal) {
                terminal.scrollTop = terminal.scrollHeight;
                // Additional smooth scroll for better UX
                terminal.scrollTo({
                    top: terminal.scrollHeight,
                    behavior: 'smooth'
                });
            }
        }

        async function executeTerminalCommand(command) {
            addTerminalOutput('>>> ' + command);
            
            try {
                if (command.trim() === 'clear') {
                    clearTerminal();
                    return;
                }
                
                if (command.trim() === 'ls') {
                    const fileList = Array.from(window.files.keys()).join('\\n');
                    addTerminalOutput(fileList || 'No files loaded');
                    return;
                }
                
                if (command.trim() === 'memory') {
                    addTerminalOutput(`Files in memory: ${window.files.size}`);
                    addTerminalOutput(`Open tabs: ${window.openTabs.length}/${maxOpenTabs}`);
                    addTerminalOutput(`Terminal lines: ${terminalLineCount}/${maxTerminalLines}`);
                    return;
                }
                
                let result = await pyodide.runPythonAsync(command);
                if (result !== undefined && result !== null) {
                    addTerminalOutput(String(result));
                }
            } catch (error) {
                addTerminalOutput(error.message, 'error');
            }
        }

        function newFile() {
            document.getElementById('newFileModal').style.display = 'block';
            document.getElementById('newFileName').focus();
        }

        function createFile() {
            const fileName = document.getElementById('newFileName').value.trim();
            if (!fileName) return;
            
            if (!fileName.endsWith('.py')) {
                alert('Please use .py extension for Python files');
                return;
            }
            
            if (window.files.has(fileName)) {
                alert('File already exists');
                return;
            }
            
            window.files.set(fileName, '# ' + fileName + '\\n\\n');
            loadFile(fileName);
            closeModal();
            updateFileTree();
        }

        function saveFile() {
            if (window.currentFile) {
                window.files.set(window.currentFile, editor.getValue());
                addTerminalOutput(`Saved ${window.currentFile}`, 'success');
                
                if (pyodide) {
                    try {
                        pyodide.FS.writeFile(`/home/user/${window.currentFile}`, editor.getValue());
                    } catch (error) {
                        console.error('Error saving to filesystem:', error);
                    }
                }
            }
        }

        function openTab(fileName) {
            loadFile(fileName);
        }

        function closeTab(fileName, event) {
            event.stopPropagation();
            const index = window.openTabs.indexOf(fileName);
            if (index > -1) {
                window.openTabs.splice(index, 1);
                cleanupFile(fileName);
            }
            
            if (window.currentFile === fileName && window.openTabs.length > 0) {
                loadFile(window.openTabs[window.openTabs.length - 1]);
            } else if (window.openTabs.length === 0) {
                window.currentFile = null;
                editor.setValue('');
                updateTabs();
                updateFileTree();
            }
        }

        function updateTabs() {
            const tabsContainer = document.getElementById('tabs');
            tabsContainer.innerHTML = '';
            
            window.openTabs.forEach(fileName => {
                const tab = document.createElement('div');
                tab.className = 'tab' + (fileName === window.currentFile ? ' active' : '');
                tab.onclick = () => openTab(fileName);
                
                tab.innerHTML = `
                    <span>${fileName}</span>
                    <span class="tab-close" onclick="closeTab('${fileName}', event)">×</span>
                `;
                
                tabsContainer.appendChild(tab);
            });
        }

        // Replace the early updateFileTree function with full implementation
        window.updateFileTree = function updateFileTree() {
            const fileTree = document.getElementById('file-tree');
            fileTree.innerHTML = '';
            
            window.exampleFiles.forEach(fileName => {
                const li = document.createElement('li');
                li.className = 'file-item' + (fileName === window.currentFile ? ' active' : '');
                li.onclick = () => loadFile(fileName);
                
                const isLoaded = window.files.has(fileName);
                const icon = isLoaded ? '📄' : '📋';
                li.innerHTML = `<span class="file-icon">${icon}</span> ${fileName}`;
                fileTree.appendChild(li);
            });
        };

        function clearTerminal() {
            terminalOutput.innerHTML = '';
            terminalLineCount = 0;
            updateMemoryInfo();
        }

        function closeModal() {
            document.getElementById('newFileModal').style.display = 'none';
            document.getElementById('newFileName').value = '';
        }

        // Terminal input handler
        terminalInput.addEventListener('keydown', async (e) => {
            if (e.key === 'Enter') {
                const command = terminalInput.value.trim();
                if (command) {
                    terminalInput.value = '';
                    await executeTerminalCommand(command);
                }
            }
        });

        // Modal handlers
        document.getElementById('newFileName').addEventListener('keydown', (e) => {
            if (e.key === 'Enter') {
                createFile();
            } else if (e.key === 'Escape') {
                closeModal();
            }
        });

        // Resize handler
        let isResizing = false;
        const resizeHandle = document.getElementById('resize-handle');
        const editorDiv = document.getElementById('editor');
        const terminalContainer = document.getElementById('terminal-container');

        resizeHandle.addEventListener('mousedown', (e) => {
            isResizing = true;
            document.body.style.cursor = 'col-resize';
        });

        document.addEventListener('mousemove', (e) => {
            if (!isResizing) return;
            
            const containerWidth = document.getElementById('editor-container').offsetWidth;
            const newEditorWidth = e.clientX - editorDiv.offsetLeft;
            const percentage = (newEditorWidth / containerWidth) * 100;
            
            if (percentage > 20 && percentage < 80) {
                editorDiv.style.width = percentage + '%';
                terminalContainer.style.width = (100 - percentage) + '%';
                editor.layout();
            }
        });

        document.addEventListener('mouseup', () => {
            isResizing = false;
            document.body.style.cursor = 'default';
        });

        // Initialize templates and file tree on page load
        document.addEventListener('DOMContentLoaded', async function() {
            console.log('🚀 DOMContentLoaded fired - initializing application');
            
            // Validate DOM elements are ready
            const fileTree = document.getElementById('file-tree');
            if (!fileTree) {
                console.error('❌ Critical DOM elements not found');
                return;
            }
            
            console.log('✅ DOM elements validated');
            
            try {
                // Load example files dynamically first
                console.log('🔄 Starting loadExampleFiles...');
                await loadExampleFiles();
                console.log('✅ Example files loaded successfully');
                
                // Validate the results
                if (window.exampleFiles.length === 0) {
                    console.warn('⚠️ No example files were loaded - entering recovery mode');
                    await attemptRecovery();
                }
                
            } catch (error) {
                console.error('❌ Error during initialization:', error);
                await attemptRecovery();
            }
        });
        
        // Recovery function for when dynamic loading fails
        async function attemptRecovery() {
            console.log('🔧 Attempting recovery...');
            
            // Try loading again after a delay
            setTimeout(async function() {
                try {
                    console.log('🔄 Retry attempt 1...');
                    await loadExampleFiles();
                    
                    if (window.exampleFiles.length > 0) {
                        console.log('✅ Recovery successful via retry');
                        return;
                    }
                } catch (retryError) {
                    console.error('❌ Retry failed:', retryError);
                }
                
                // Ultimate fallback: create static templates
                console.log('🆘 Creating static fallback templates');
                createStaticFallback();
                
            }, 2000);
        }
        
        // Static fallback when all dynamic loading fails
        function createStaticFallback() {
            console.log('📝 Creating static template fallbacks');
            
            const staticFiles = {
                'welcome.py': `# Welcome to Python Online IDE!
# This is a fallback template - server files could not be loaded

print("Welcome to Python!")
print("This IDE lets you write and run Python code in your browser.")
print("Try editing this code and clicking 'Run' to see the results!")

# Example: Basic calculations
x = 10
y = 5
print(f"x + y = {x + y}")
print(f"x * y = {x * y}")`,

                '01_hello_world.py': `# Hello World Example
# This is a fallback template

print("Hello, World!")
print("This is your first Python program!")

# Try changing the message below
message = "Python is awesome!"
print(message)`,

                '02_variables.py': `# Variables Example
# This is a fallback template

# Different types of variables
name = "Alice"
age = 25
height = 5.6
is_student = True

print(f"Name: {name}")
print(f"Age: {age}")
print(f"Height: {height} feet")
print(f"Is student: {is_student}")`
            };
            
            // Create templates
            Object.entries(staticFiles).forEach(([filename, content]) => {
                window.exampleTemplates[filename] = content;
                console.log(`📄 Created static template: ${filename}`);
            });
            
            // Update arrays
            window.exampleFiles = Object.keys(window.exampleTemplates);
            
            // Update UI
            if (window.updateFileTree) {
                window.updateFileTree();
                console.log('🌳 File tree updated with static templates');
            }
            
            console.log(`✅ Static fallback complete: ${window.exampleFiles.length} files available`);
        }

        // Initialize Python when page loads
        initPython();
        
        // Debug function to test global state (accessible from browser console)
        window.debugGlobalState = function() {
            console.log('=== GLOBAL STATE DEBUG ===');
            console.log('window.exampleFiles:', window.exampleFiles);
            console.log('window.exampleFiles.length:', window.exampleFiles ? window.exampleFiles.length : 'undefined');
            console.log('window.exampleTemplates:', window.exampleTemplates);
            console.log('window.exampleTemplates keys:', window.exampleTemplates ? Object.keys(window.exampleTemplates) : 'undefined');
            console.log('window.files:', window.files);
            console.log('window.files.size:', window.files ? window.files.size : 'undefined');
            console.log('window.currentFile:', window.currentFile);
            console.log('window.openTabs:', window.openTabs);
            console.log('loadExampleFiles function:', typeof loadExampleFiles);
            console.log('updateFileTree function:', typeof window.updateFileTree);
            console.log('========================');
            
            // Test if the file tree has content
            const fileTree = document.getElementById('file-tree');
            if (fileTree) {
                console.log('File tree DOM children:', fileTree.children.length);
                console.log('File tree innerHTML length:', fileTree.innerHTML.length);
            }
            
            return {
                exampleFiles: window.exampleFiles,
                exampleTemplates: Object.keys(window.exampleTemplates || {}),
                filesInMemory: window.files ? window.files.size : 0,
                currentFile: window.currentFile,
                openTabs: window.openTabs,
                fileTreeChildren: fileTree ? fileTree.children.length : 0
            };
        };
        
        console.log('💡 Debug tip: Run window.debugGlobalState() in console to check global state');
    </script>
</body>
</html>